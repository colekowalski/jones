{% extends "layout.html" %}
{% set page_title = "Jones" %}
{% block head %}
<link rel=stylesheet href="{{ url_for('.static', filename='css/jsoneditor.css') }}">
<script>
var config = {{ config | tojson |safe }};

</script>
{% endblock %}
{% block body %}
<div class="modal hide" id="myModal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">Ã—</button>
    <h3>Add child</h3>
    <h4></h4>
  </div>
  <div class="modal-body">
      <form>
          <label>Child</label>
          <input type="text">
      </form>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
    <a id="modalSubmit" href="#" class="btn btn-primary">Save changes</a>
  </div>
</div>

<h2>{{ service }}</h2>
<h3>/{% if env %}{{env}}{% endif %}</h3>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span4 well">
            <h4>Environments</h4>
            <table class="env-table table table-condensed table-striped">
                <tbody>
                    {% for child, is_leaf in children %}
                    {% set ischild = (child[1:] == (env or '')) %}
                    {% set child_url = "/service/%s%s"|format(service, child) %}
                    {% if child %}
                    {% set child_pretty = child %}
                    {% else %}
                    {% set child_pretty = "/" %}
                    {% endif %}

                    <tr>
                        <td>
                            {% if ischild%}
                            <span><strong>{{ child_pretty }}</strong></span>
                            {% else %}
                            <a href="{{ child_url }}"><span>{{ child_pretty }}</span></a>
                            {% endif %}
                            <span style="float:right;">
                                {% if is_leaf %}
                                <a class="btn del-env btn-mini" href="{{ child_url }}">Delete</a>
                                {% endif %}
                                <a class="btn add-env btn-mini"
                                    {#data-toggle="modal" data-target='#myModal'#}
                                    href="{{ child_url }}">Add Child</a>
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <h4>Inherited View</h4>
            <pre>{{ view | as_json(2) }}</pre>
        </div>
        <div class="span8">
            <div id="jsoneditor"></div>
            <div id="jsonformatter"></div>
            <button id="update">Update</button>
        </div>
    </div>
</div>
{% endblock %}
{% block footer %}
<script src="{{ url_for('.static', filename='js/json2.js') }}"></script>
<script src="{{ url_for('.static', filename='js/jsoneditor-min.js') }}"></script>
<script>
var addChildHeaderTpl = "Add child to ";
$(function() {
    window.editor = new JSONEditor($('#jsoneditor')[0]);
    window.editor.set(config);
    $('#update').click(function() {
        console.log(JSON.stringify(editor.get()));
    });

    $('#myModal form').submit(function() {
        $('#modalSubmit').click();
        return false;
    });

    $('.add-env').click(function() {
        var input = $('#myModal input');
        var href = $(this).attr('href');

        $('#myModal .modal-header h4').text(href);
        $('#myModal').modal();
        input.focus();
        console.log(href);
        $('#modalSubmit').click(function() {
            console.log(input.val());
            console.log(href);

            // TODO: validate no slashes
            $.post(href + '/' + input.val(), {}, function () {
                $('#myModal').modal('hide');
                window.location.reload(true);
            });
            return false;
        });
        return false;
    });

    $('#myModal').on('hide', function () {
        $('#modalSubmit').unbind('click');
    });

    $('.del-env').click(function() {
        var href = $(this).attr('href');

        $.ajax({
            url: href,
            type: 'delete',
            success: function() {
                window.location.reload(true);
            }
        });
        return false;
    });

    /*
    window.formatter = new JSONFormatter($('#jsonformatter')[0]);
    window.formatter.set(config);
    window.formatter.onError = console.log
    */
});
</script>

{% endblock %}
